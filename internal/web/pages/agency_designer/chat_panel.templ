package agency_designer

import (
	"github.com/aosanya/CodeValdCortex/internal/ai"
	"github.com/aosanya/CodeValdCortex/internal/agency"
)

// ChatPanel renders the AI chat panel for the agency designer
templ ChatPanel(currentAgency *agency.Agency, conversation *ai.ConversationContext) {
	<aside class="chat-panel">
		<header class="chat-header">
			<div class="chat-header-content">
				<span class="icon is-medium has-text-primary">
					<i class="fas fa-comments"></i>
				</span>
				<div>
					<h3 class="chat-title">Designer</h3>
					<p class="chat-subtitle">{ currentAgency.Name }</p>
				</div>
			</div>
		</header>
		
		<div class="chat-messages-container" id="chat-messages">
			if conversation != nil && len(conversation.Messages) > 0 {
				@ChatMessages(conversation.Messages)
			} else {
				@WelcomeMessage(currentAgency.Name)
			}
		</div>
		
		<!-- Typing Indicator -->
		<div class="typing-indicator" id="typing-indicator" style="display: none;">
			<div class="typing-bubble">
				<span></span><span></span><span></span>
			</div>
		</div>
		
		<!-- Context Panel (between messages and input) -->
		<div class="chat-context-section">
			@ContextPanel()
		</div>
		
		<!-- Chat Input (Independent) -->
		<div class="chat-input-container">
			<!-- AI Process Status Bar (inside input panel) -->
			<div class="ai-process-status htmx-indicator" id="ai-process-status" style="display: none;">
				<div class="process-content">
					<div class="process-info">
						<span class="icon has-text-info">
							<i class="fas fa-spinner fa-spin"></i>
						</span>
						<span class="process-text" id="ai-status-message">AI is working on your request...</span>
					</div>
					<button class="button is-small is-danger is-outlined" id="stop-ai-process" title="Stop AI processing">
						<span class="icon is-small">
							<i class="fas fa-stop"></i>
						</span>
						<span>Stop</span>
					</button>
				</div>
			</div>
			
			@ChatInput(currentAgency.ID, conversation)
		</div>
	</aside>
}

// WelcomeMessage displays the initial greeting
templ WelcomeMessage(agencyName string) {
	<div class="message ai-message welcome-message">
		<div class="message-avatar">
			<span class="icon is-large has-text-primary">
				<i class="fas fa-robot fa-2x"></i>
			</span>
		</div>
		<div class="message-content">
			<div class="message-bubble">
				<p><strong>Hi! I'm your AI Agency Designer.</strong> ðŸ¤–</p>
				<p>I'll help you create a complete multi-agent architecture for <strong>{ agencyName }</strong>.</p>
				<p>Let's start by understanding your use case:</p>
				<ul>
					<li>What problem are you trying to solve?</li>
					<li>What are the main processes or workflows?</li>
					<li>Who are the key actors or stakeholders?</li>
				</ul>
				<p class="mt-4"><em>ðŸ’¡ Tip: Be as detailed as you can - I'll help you refine the details as we go!</em></p>
			</div>
		</div>
	</div>
}

// ChatMessages renders the conversation history
templ ChatMessages(messages []ai.Message) {
	for _, msg := range messages {
		if msg.Role == "user" {
			@UserMessage(msg)
		} else if msg.Role == "assistant" {
			@AIMessage(msg)
		}
		// Skip system messages - they should not be displayed to users
	}
}

// UserMessage renders a user message bubble
templ UserMessage(msg ai.Message) {
	<div class="message user-message">
		<div class="message-content">
			<div class="message-bubble">
				<p>{ msg.Content }</p>
			</div>
			<div class="message-time">
				{ msg.Timestamp.Format("3:04 PM") }
			</div>
		</div>
		<div class="message-avatar">
			<span class="icon is-medium has-text-info">
				<i class="fas fa-user"></i>
			</span>
		</div>
	</div>
}

// AIMessage renders an AI assistant message bubble
templ AIMessage(msg ai.Message) {
	<div class="message ai-message">
		<div class="message-avatar">
			<span class="icon is-medium has-text-primary">
				<i class="fas fa-robot"></i>
			</span>
		</div>
		<div class="message-content">
			<div class="message-bubble">
				@templ.Raw(formatAIMessage(msg.Content))
			</div>
			<div class="message-time">
				{ msg.Timestamp.Format("3:04 PM") }
			</div>
		</div>
	</div>
}

// ChatInput renders the message input form
templ ChatInput(agencyID string, conversation *ai.ConversationContext) {
	<form 
		hx-post={ getMessageEndpoint(agencyID, conversation) }
		hx-target="#chat-messages"
		if conversation == nil || len(conversation.Messages) == 0 {
			hx-swap="innerHTML"
		} else {
			hx-swap="beforeend"
		}
		hx-indicator="#typing-indicator"
		hx-on::before-request="
			console.log('ðŸš€ CHAT: Sending message...');
			console.log('ðŸ“ CHAT: Target:', '#chat-messages');
			console.log('ðŸ”„ CHAT: Swap strategy:', event.target.getAttribute('hx-swap'));
			const input = document.getElementById('user-input');
			console.log('ðŸ’¬ CHAT: Message:', input.value);
			const contexts = window.ContextManager ? window.ContextManager.getFormattedContexts() : '';
			if (contexts) {
				console.log('ðŸ“Ž CHAT: Adding contexts:', contexts);
				input.value = input.value + contexts;
			}
		"
		hx-on::after-request="
			console.log('âœ… CHAT: Response received');
			console.log('ðŸ“¦ CHAT: Response status:', event.detail.xhr.status);
			console.log('ðŸ“„ CHAT: Response length:', event.detail.xhr.responseText.length);
			console.log('ðŸ“ CHAT: Response HTML:', event.detail.xhr.responseText);
			const target = document.getElementById('chat-messages');
			console.log('ðŸŽ¯ CHAT: Target element:', target);
			console.log('ðŸ” CHAT: Target innerHTML before swap:', target.innerHTML.substring(0, 200));
			console.log('ðŸ“ CHAT: Container dimensions:', {
				height: target.offsetHeight,
				scrollHeight: target.scrollHeight,
				clientHeight: target.clientHeight,
				display: window.getComputedStyle(target).display,
				overflow: window.getComputedStyle(target).overflow
			});
			document.getElementById('user-input').value = ''; 
			target.scrollTop = target.scrollHeight;
			// Check messages after a brief delay to let HTMX complete
			setTimeout(() => {
				const messages = target.querySelectorAll('.message');
				console.log('ðŸ’¬ CHAT: Message count:', messages.length);
				if (messages.length > 0) {
					const firstMsg = messages[0];
					const styles = window.getComputedStyle(firstMsg);
					console.log('ðŸ‘ï¸ CHAT: First message styles:', {
						display: styles.display,
						opacity: styles.opacity,
						visibility: styles.visibility,
						height: firstMsg.offsetHeight,
						classes: firstMsg.className
					});
				}
			}, 100);
		"
		hx-on::after-swap="
			console.log('ðŸ”„ CHAT: Content swapped successfully');
			const chatMessages = document.getElementById('chat-messages');
			console.log('ðŸ“Š CHAT: Messages in container:', chatMessages.children.length);
			console.log('ðŸ” CHAT: Target innerHTML after swap:', chatMessages.innerHTML.substring(0, 200));
			console.log('ðŸ’¡ CHAT: All children:', Array.from(chatMessages.children).map(c => c.className));
		"
		hx-on::response-error="
			console.error('âŒ CHAT: Response error:', event.detail);
		"
		hx-on::before-swap="
			console.log('ðŸ”€ CHAT: About to swap content');
			console.log('ðŸ”€ CHAT: Swap style:', event.detail.shouldSwap);
			console.log('ðŸ”€ CHAT: Target:', event.detail.target);
		">>>
		
		<div class="field has-addons">
			<div class="control is-expanded">
				<input 
					class="input" 
					type="text" 
					name="message"
					id="user-input"
					placeholder="Describe your requirements..."
					required
					autocomplete="off"/>
			</div>
			<div class="control">
				<button class="button is-primary" type="submit">
					<span class="icon">
						<i class="fas fa-paper-plane"></i>
					</span>
				</button>
			</div>
		</div>
		
		<!-- Context indicator -->
		<div id="context-indicator" class="mt-2" style="display: none;">
			<div class="tags">
				<span class="tag is-info is-light">
					<span class="icon is-small">
						<i class="fas fa-layer-group"></i>
					</span>
					<span id="context-count">0 contexts</span>
				</span>
			</div>
		</div>
	</form>
}