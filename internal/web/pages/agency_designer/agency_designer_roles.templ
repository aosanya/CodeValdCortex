package agency_designer

import (
	"fmt"
	"github.com/aosanya/CodeValdCortex/internal/agency/models"
)

// RoleItem renders a single role in the list as a table row
templ RoleItem(role *models.Role) {
	<tr 
		class="table-item" 
		data-item-key={ role.Key }>
		<td style="vertical-align: middle; width: 40px;">
			<label class="checkbox">
				<input 
					type="checkbox" 
					class="role-checkbox" 
					data-role-key={ role.Key }
					onchange="updateRoleSelectionButtons()"/>
			</label>
		</td>
		<td style="vertical-align: middle;">
			<span class="tag is-info">{ role.ID }</span>
		</td>
		<td style="vertical-align: middle;">
			<div>
				<div class="is-flex is-align-items-center mb-1">
					if role.Icon != "" {
						<span class="mr-2" style="font-size: 1.2em;">{ role.Icon }</span>
					}
					<span class="has-text-weight-semibold">{ role.Name }</span>
				</div>
				if role.Description != "" {
					<p class="is-size-7 has-text-grey mb-2">{ truncateText(role.Description, 100) }</p>
				}
				<div class="tags are-small">
					if role.AutonomyLevel != "" {
						<span class="tag is-primary is-light">
							<span class="icon is-small"><i class="fas fa-robot"></i></span>
							<span>{ role.AutonomyLevel }</span>
						</span>
					}
					if role.TokenBudget > 0 {
						<span class="tag is-info is-light">
							<span class="icon is-small"><i class="fas fa-coins"></i></span>
							<span>{ formatTokenBudget(role.TokenBudget) }</span>
						</span>
					}
					if len(role.Tags) > 0 {
						for _, tag := range role.Tags {
							<span class="tag is-light">{ tag }</span>
						}
					}
				</div>
			</div>
		</td>
		<td style="vertical-align: middle;">
			<div class="buttons">
				<button 
					class="button is-small is-light is-fullwidth"
					onclick={ templ.ComponentScript{Call: fmt.Sprintf("window.ContextManager.addRoleContext('%s', '%s')", role.ID, templ.EscapeString(getRoleContextText(role)))} }
					title="Add to context">
					<span class="icon"><i class="fas fa-layer-group"></i></span>
					<span>Context</span>
				</button>
				<button 
					class="button is-small is-info is-fullwidth" 
					onclick={ templ.ComponentScript{Call: fmt.Sprintf("showRoleEditor('edit', '%s')", role.Key)} }
					title="Edit">
					<span class="icon"><i class="fas fa-edit"></i></span>
					<span>Edit</span>
				</button>
				<button 
					class="button is-small is-danger is-fullwidth" 
					onclick={ templ.ComponentScript{Call: fmt.Sprintf("deleteRole('%s')", role.Key)} }
					title="Delete">
					<span class="icon"><i class="fas fa-trash"></i></span>
					<span>Delete</span>
				</button>
			</div>
		</td>
	</tr>
}

// AgencyRolesList renders all roles as table rows
templ AgencyRolesList(roles []*models.Role) {
	if len(roles) == 0 {
		<tr>
			<td colspan="4" class="has-text-grey has-text-centered py-5">
				<p><i class="fas fa-info-circle"></i> No roles defined yet. Click the + button to add one.</p>
			</td>
		</tr>
	} else {
		for _, role := range roles {
			@RoleItem(role)
		}
	}
}

// Helper function to format token budget
func formatTokenBudget(budget int64) string {
	if budget >= 1000000 {
		return fmt.Sprintf("%.1fM", float64(budget)/1000000)
	} else if budget >= 1000 {
		return fmt.Sprintf("%.1fK", float64(budget)/1000)
	}
	return fmt.Sprintf("%d", budget)
}

// Helper function to get autonomy level label
func getAutonomyLabel(role *models.Role) string {
	if role.AutonomyLevel != "" {
		return role.AutonomyLevel
	}
	return "L2"
}

// Helper function to get context text (description or name as fallback)
func getRoleContextText(role *models.Role) string {
	if role.Description != "" {
		return role.Description
	}
	return role.Name
}
