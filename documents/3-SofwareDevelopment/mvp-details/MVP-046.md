# MVP-046: Agency Admin & Configuration Page

**Status**: Not Started  
**Priority**: P1  
**Estimated Effort**: 5 days  
**Dependencies**: MVP-044 (Roles UI Module)

---

## Objective

Create a comprehensive administration and configuration page for managing agency-level settings, including token budgets, rate limits, resource quotas, AI model selection, cost controls, and monitoring dashboards. This page provides operators with centralized control over agency resource consumption and operational parameters.

---

## Key Deliverables

### 1. Data Models

```go
type AgencyConfiguration struct {
    AgencyID         string                  `json:"agency_id"`
    TokenBudgets     TokenBudgetConfig       `json:"token_budgets"`
    RateLimits       RateLimitConfig         `json:"rate_limits"`
    ResourceQuotas   ResourceQuotaConfig     `json:"resource_quotas"`
    AIModelSettings  AIModelConfig           `json:"ai_model_settings"`
    CostControls     CostControlConfig       `json:"cost_controls"`
    MonitoringSettings MonitoringConfig      `json:"monitoring_settings"`
    UpdatedAt        time.Time               `json:"updated_at"`
    UpdatedBy        string                  `json:"updated_by"`
}

type TokenBudgetConfig struct {
    TotalBudget      int64                   `json:"total_budget"`
    UsedTokens       int64                   `json:"used_tokens"`
    AgentTypeBudgets map[string]int64        `json:"agent_type_budgets"` // key: AgentTypeKey
    IndividualBudgets map[string]int64       `json:"individual_budgets"` // key: AgentID
    ResetPeriod      string                  `json:"reset_period"`       // daily, weekly, monthly
    AlertThresholds  AlertThresholds         `json:"alert_thresholds"`
}

type AlertThresholds struct {
    WarningPercent   int `json:"warning_percent"`   // e.g., 80%
    CriticalPercent  int `json:"critical_percent"`  // e.g., 95%
}

type RateLimitConfig struct {
    RequestsPerMinute  int `json:"requests_per_minute"`
    RequestsPerHour    int `json:"requests_per_hour"`
    ConcurrentRequests int `json:"concurrent_requests"`
    BurstAllowance     int `json:"burst_allowance"`
}

type ResourceQuotaConfig struct {
    MaxAgents          int `json:"max_agents"`
    MaxAgentTypes      int `json:"max_agent_types"`
    MaxWorkItems       int `json:"max_work_items"`
    MaxGoals           int `json:"max_goals"`
    MaxMemoryPerAgent  int `json:"max_memory_per_agent_mb"`
    MaxStorageSize     int `json:"max_storage_size_mb"`
}

type AIModelConfig struct {
    DefaultModel       string              `json:"default_model"`
    AllowedModels      []string            `json:"allowed_models"`
    ModelPriorities    map[string]int      `json:"model_priorities"`
    FallbackModel      string              `json:"fallback_model"`
    TemperatureDefault float64             `json:"temperature_default"`
}

type CostControlConfig struct {
    MonthlyBudgetUSD   float64 `json:"monthly_budget_usd"`
    CurrentSpendUSD    float64 `json:"current_spend_usd"`
    CostPerToken       float64 `json:"cost_per_token"`
    AlertOnOverspend   bool    `json:"alert_on_overspend"`
    HardLimitEnabled   bool    `json:"hard_limit_enabled"`
}

type MonitoringConfig struct {
    EnableDashboard    bool   `json:"enable_dashboard"`
    MetricsRetention   int    `json:"metrics_retention_days"`
    AlertEmail         string `json:"alert_email"`
    WebhookURL         string `json:"webhook_url"`
}
```

### 2. Admin Page Layout

**Tabbed Interface**:
- üí∞ **Token Budgets**: Manage token allocations
- ‚è±Ô∏è **Rate Limits**: Configure API rate limiting
- üìä **Resource Quotas**: Set resource constraints
- ü§ñ **AI Models**: Select and prioritize models
- üíµ **Cost Controls**: Budget and spending management
- üìà **Monitoring**: Dashboards and alerts

### 3. Token Budget Management Interface

```html
<div class="tab-content" id="token-budgets">
  <div class="box">
    <h2 class="title is-4">Agency-Wide Token Budget</h2>
    
    <div class="field">
      <label class="label">Total Token Budget</label>
      <div class="control">
        <input type="number" class="input" value="10000000" 
               placeholder="e.g., 10,000,000 tokens">
      </div>
      <p class="help">Total tokens available for this agency per reset period</p>
    </div>
    
    <div class="field">
      <label class="label">Reset Period</label>
      <div class="control">
        <div class="select">
          <select>
            <option>Daily</option>
            <option selected>Weekly</option>
            <option>Monthly</option>
          </select>
        </div>
      </div>
    </div>
    
    <div class="progress-wrapper mt-4">
      <label class="label">Current Usage</label>
      <progress class="progress is-primary" value="45" max="100">45%</progress>
      <p class="help">4,500,000 / 10,000,000 tokens used (45%)</p>
    </div>
  </div>
  
  <div class="box mt-5">
    <h2 class="title is-4">Role Token Budgets</h2>
    
    <table class="table is-fullwidth is-striped">
      <thead>
        <tr>
          <th>Role</th>
          <th>Key</th>
          <th>Budget</th>
          <th>Usage</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Sensor Agent</td>
          <td><code>AT-001</code></td>
          <td>
            <input type="number" class="input is-small" value="1000000"
                   max="10000000" 
                   onchange="updateTypeBudget('AT-001', this.value)">
          </td>
          <td>450,000</td>
          <td>
            <progress class="progress is-success" value="45" max="100">45%</progress>
          </td>
          <td>
            <button class="button is-small is-info">Details</button>
          </td>
        </tr>
        <!-- More roles -->
      </tbody>
    </table>
  </div>
  
  <h2 class="title is-4 mt-5">Individual Agent Budgets</h2>
  
  <div class="box">
    <p class="subtitle is-6">Sensor Role (AT-001)</p>
    <table class="table is-fullwidth">
      <thead>
        <tr>
          <th>Agent ID</th>
          <th>Agent Name</th>
          <th>Budget</th>
          <th>Usage</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>agent-001</td>
          <td>Pressure Monitor A1</td>
          <td>
            <input type="number" class="input is-small" value="100000"
                   max="1000000" 
                   onchange="updateAgentBudget('agent-001', this.value)">
            <p class="help">Max: 1,000,000 (Role Budget)</p>
          </td>
          <td>45,000</td>
          <td><span class="tag is-success">Healthy</span></td>
        </tr>
        <!-- More agents -->
      </tbody>
    </table>
  </div>
  
  <div class="notification is-info is-light mt-4">
    <strong>‚ÑπÔ∏è Budget Rules:</strong>
    <ul>
      <li>Each agent's budget must be ‚â§ its role's total budget</li>
      <li>Sum of all agent budgets for a type cannot exceed the type's total budget</li>
      <li>Warnings triggered at 80% usage, critical alerts at 95%</li>
      <li>Agents are throttled when individual budgets are exceeded</li>
    </ul>
  </div>
</div>

<!-- Other tabs: Rate Limits, Quotas, AI Models, Costs, Monitoring -->
```

### 4. Backend Services

- **AgencyConfigService** interface and implementation
- Token budget tracking and enforcement service
- Rate limiting middleware
- Quota validation service
- Cost calculation service
- Alert/notification service
- Audit logging service

### 5. API Endpoints

```
GET    /api/v1/agencies/{id}/config                    # Get full configuration
PUT    /api/v1/agencies/{id}/config                    # Update configuration

# Token Budgets
GET    /api/v1/agencies/{id}/config/token-budgets
PUT    /api/v1/agencies/{id}/config/token-budgets/agent-types/{key}
PUT    /api/v1/agencies/{id}/config/token-budgets/agents/{agentId}
GET    /api/v1/agencies/{id}/token-usage                # Current usage stats

# Rate Limits
GET    /api/v1/agencies/{id}/config/rate-limits
PUT    /api/v1/agencies/{id}/config/rate-limits

# Resource Quotas
GET    /api/v1/agencies/{id}/config/quotas
PUT    /api/v1/agencies/{id}/config/quotas

# AI Models
GET    /api/v1/agencies/{id}/config/ai-models
PUT    /api/v1/agencies/{id}/config/ai-models
GET    /api/v1/ai-models/available                     # Available models list

# Cost Controls
GET    /api/v1/agencies/{id}/config/costs
PUT    /api/v1/agencies/{id}/config/costs
GET    /api/v1/agencies/{id}/costs/current             # Current spending

# Monitoring
GET    /api/v1/agencies/{id}/monitoring/dashboard      # Dashboard data
GET    /api/v1/agencies/{id}/monitoring/alerts         # Alert history
GET    /api/v1/agencies/{id}/audit-logs                # Configuration changes
```

### 6. Budget Enforcement Logic

- Runtime checks before AI API calls
- Reject requests when budget exceeded
- Return budget status in API responses
- Automatic throttling near limits
- Grace period handling
- Budget reset automation

### 7. Alerting System

- Email notifications
- In-app notifications
- Webhook integrations
- Alert types:
  * Budget warning (80% threshold)
  * Budget critical (95% threshold)
  * Budget exceeded (100%)
  * Rate limit violations
  * Quota exceeded
  * Cost alerts

---

## Acceptance Criteria

- [ ] Admin page displays all configuration sections
- [ ] Token budgets can be set at role level
- [ ] Individual agent budgets can be configured
- [ ] Budget constraints enforced (agent ‚â§ type budget)
- [ ] Real-time usage monitoring visible
- [ ] Progress bars show budget utilization
- [ ] Rate limits configurable and enforced
- [ ] Resource quotas prevent over-provisioning
- [ ] AI model selection persists and applies
- [ ] Cost tracking shows accurate spending
- [ ] Alerts trigger at configured thresholds
- [ ] Budget enforcement stops/throttles agents when exceeded
- [ ] Audit logs track all configuration changes
- [ ] Export functionality works for reports
- [ ] Permission-based access (admin only)

---

## Implementation Notes

### Token Budget Hierarchy
- **Agency Level**: Total budget pool for all operations
- **Role Level**: Budget allocation per role
- **Individual Agent Level**: Budget per specific agent instance
- Constraint: Sum of agent budgets ‚â§ role budget ‚â§ agency budget

### Real-time Enforcement
- Middleware intercepts AI API calls
- Checks remaining budget before execution
- Updates usage counters after successful calls
- Returns 429 (Too Many Requests) when budget exceeded

### Monitoring Dashboard
- Live usage charts (line graphs, bar charts)
- Budget vs. actual comparison
- Top consumers by role
- Historical trends
- Alert history timeline
- Cost projections based on current usage

### Permission Model
- Only users with `admin` or `operator` roles can access
- Audit logs track all configuration changes
- Changes require confirmation for critical settings
- Rollback capability for configuration changes
