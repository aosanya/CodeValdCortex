# MVP-051: Workflow Manager - List & CRUD

**Priority**: P1 (Critical)  
**Effort**: Medium  
**Status**: In Progress  
**Dependencies**: MVP-032 (Work Items Assignment & Routing)

## Overview

Build a workflow management interface for creating, listing, editing, and deleting workflows. This follows the same design pattern as the Work Items and Roles sections in the agency designer. Users can manage workflow metadata, version control, and basic configuration before moving to the visual designer (MVP-052) for connecting nodes.

## Business Value

- **Workflow Organization**: Centralized management of all workflows in an agency
- **Version Control**: Track workflow versions and changes over time
- **Quick Access**: List view with search and filtering capabilities
- **Foundation for Visual Design**: Provides the CRUD layer needed before visual design
- **Reusable Templates**: Save and duplicate workflows for common processes

## Technical Stack

### Backend
- **Framework**: Go (Gin framework)
- **Database**: ArangoDB for workflow storage
- **Models**: Workflow, WorkflowExecution entities
- **Repository**: CRUD operations for workflows

### Frontend
- **Templates**: Templ for server-side rendering
- **Styling**: Bulma CSS (following existing design patterns)
- **Interactivity**: Alpine.js for dynamic behavior
- **Navigation**: Positioned under "RACI Matrix" section

### Design Pattern
Follow the same UI/UX patterns as:
- Work Items section (`agency_designer_work_items.templ`)
- Roles section (`agency_designer_roles.templ`)
- List cards with editor cards
- Modal or side panel for editing

## Core Features

### 1. Navigation Integration

Add "Workflows" section to agency designer navigation:
- **Position**: Under "RACI Matrix" section
- **Icon**: `fa-sitemap` or `fa-diagram-project`
- **Navigation**: Clicking loads workflow list view
- **Badge**: Show count of workflows for the agency

### 2. Workflows List View

#### List Card Component (`workflows_list_card.templ`)
Display all workflows for the current agency:

**Card Header**:
- Title: "Workflows"
- Count badge: Number of workflows
- "New Workflow" button (primary action)
- Search/filter input

**List Items** (each workflow):
- Workflow name
- Description (truncated)
- Version number
- Status badge (Draft, Active, Paused)
- Node count (e.g., "5 nodes")
- Last updated timestamp
- Actions: Edit, Duplicate, Delete

**Empty State**:
- "No workflows yet" message
- Call-to-action to create first workflow
- Optional: Quick start templates

### 3. Workflow Editor Card

#### Editor Form (`workflow_editor_card.templ`)
Modal or side panel for creating/editing workflows:

**Basic Information**:
- Workflow name (required)
- Description (textarea)
- Version (auto-incremented or manual)
- Status (Draft/Active)

**Metadata**:
- Created by (auto-filled)
- Created date (auto-filled)
- Last updated (auto-filled)
- Tags (optional, for categorization)

**Actions**:
- Save workflow
- Cancel
- "Open in Designer" button (navigates to MVP-052 visual designer)

### 4. Workflow Operations

#### Create Workflow
- Open editor with empty form
- Default status: Draft
- Version: 1.0.0
- Initialize with empty nodes array
- Save to database
- Refresh list

#### Edit Workflow
- Load workflow data
- Populate form
- Allow metadata updates
- Version increment option
- Save changes
- Refresh list

#### Duplicate Workflow
- Copy workflow data
- Append "(Copy)" to name
- Reset created date
- Increment version or reset to 1.0.0
- Open editor for review
- Save as new workflow

#### Delete Workflow
- Confirmation modal
- Check for active executions
- Soft delete or hard delete option
- Remove from list
- Show success notification

### 5. Validation

- **Name**: Required, min 3 characters
- **Version**: Semantic versioning format (x.y.z)
- **Status**: Must be valid enum value
- **Agency**: Must belong to current agency

## Data Models

### Workflow Definition (JSON)

```json
{
  "id": "workflow_123",
  "name": "Customer Onboarding",
  "version": "1.0.0",
  "description": "Complete customer onboarding process",
  "created_at": "2025-11-06T10:00:00Z",
  "updated_at": "2025-11-06T15:30:00Z",
  "created_by": "user_456",
  "status": "active",
  "nodes": [
    {
      "id": "node_1",
      "type": "start",
      "position": {"x": 100, "y": 100},
      "data": {
        "trigger": "manual"
      }
    },
    {
      "id": "node_2",
      "type": "work_item",
      "position": {"x": 300, "y": 100},
      "data": {
        "work_item_id": "wi_collect_documents",
        "work_item_type": "data_collection",
        "name": "Collect Customer Documents",
        "role": "onboarding_specialist",
        "sla_hours": 24,
        "parameters": {
          "required_documents": ["ID", "Proof of Address"]
        }
      }
    },
    {
      "id": "node_3",
      "type": "decision",
      "position": {"x": 500, "y": 100},
      "data": {
        "condition": "documents_complete == true",
        "name": "Documents Complete?"
      }
    },
    {
      "id": "node_4",
      "type": "work_item",
      "position": {"x": 700, "y": 50},
      "data": {
        "work_item_id": "wi_verify_documents",
        "name": "Verify Documents",
        "role": "compliance_officer"
      }
    },
    {
      "id": "node_5",
      "type": "work_item",
      "position": {"x": 700, "y": 150},
      "data": {
        "work_item_id": "wi_request_missing",
        "name": "Request Missing Documents",
        "role": "onboarding_specialist"
      }
    },
    {
      "id": "node_6",
      "type": "end",
      "position": {"x": 900, "y": 100},
      "data": {
        "status": "success"
      }
    }
  ],
  "edges": [
    {
      "id": "edge_1",
      "source": "node_1",
      "target": "node_2",
      "type": "sequential"
    },
    {
      "id": "edge_2",
      "source": "node_2",
      "target": "node_3",
      "type": "sequential"
    },
    {
      "id": "edge_3",
      "source": "node_3",
      "target": "node_4",
      "type": "conditional",
      "data": {
        "condition": "true"
      }
    },
    {
      "id": "edge_4",
      "source": "node_3",
      "target": "node_5",
      "type": "conditional",
      "data": {
        "condition": "false"
      }
    },
    {
      "id": "edge_5",
      "source": "node_4",
      "target": "node_6",
      "type": "sequential"
    },
    {
      "id": "edge_6",
      "source": "node_5",
      "target": "node_2",
      "type": "sequential",
      "data": {
        "label": "Retry collection"
      }
    }
  ],
  "variables": {
    "customer_id": "",
    "documents_complete": false
  }
}
```

### Workflow Execution Instance

```json
{
  "id": "exec_789",
  "workflow_id": "workflow_123",
  "workflow_version": "1.0.0",
  "status": "running",
  "started_at": "2025-11-06T16:00:00Z",
  "completed_at": null,
  "started_by": "user_456",
  "context": {
    "customer_id": "cust_001",
    "documents_complete": false
  },
  "node_executions": [
    {
      "node_id": "node_1",
      "status": "completed",
      "started_at": "2025-11-06T16:00:00Z",
      "completed_at": "2025-11-06T16:00:01Z",
      "output": {}
    },
    {
      "node_id": "node_2",
      "status": "running",
      "started_at": "2025-11-06T16:00:01Z",
      "assigned_agent": "agent_123",
      "output": null
    }
  ],
  "errors": []
}
```

## API Endpoints

### Workflow Management

```
POST   /api/v1/agencies/:agencyId/workflows           - Create new workflow
GET    /api/v1/agencies/:agencyId/workflows           - List workflows for agency
GET    /api/v1/workflows/:id                          - Get workflow by ID
PUT    /api/v1/workflows/:id                          - Update workflow metadata
DELETE /api/v1/workflows/:id                          - Delete workflow
POST   /api/v1/workflows/:id/duplicate                - Duplicate workflow
```

### Validation

```
POST   /api/v1/workflows/validate                     - Validate workflow definition
```

## Implementation Phases

### Phase 1: Backend Foundation (Days 1-2)
- [x] Create workflow models (`internal/workflow/models.go`)
- [x] Create repository interface (`internal/workflow/repository.go`)
- [ ] Implement ArangoDB repository
- [ ] Create workflow service with CRUD operations
- [ ] Add API endpoints for workflow management
- [ ] Write unit tests for service layer

### Phase 2: Navigation & Routing (Day 3)
- [ ] Add "Workflows" navigation item under RACI Matrix
- [ ] Create routes for workflow pages
- [ ] Create workflow handler (`workflow_handler.go`)
- [ ] Set up page templates structure

### Phase 3: List View (Days 4-5)
- [ ] Create `agency_designer_workflows.templ` (main page)
- [ ] Create `workflows_list_card.templ` component
- [ ] Implement list rendering with Alpine.js
- [ ] Add search and filtering
- [ ] Add empty state
- [ ] Implement delete with confirmation

### Phase 4: Editor (Days 6-7)
- [ ] Create `workflow_editor_card.templ` component
- [ ] Implement create workflow form
- [ ] Implement edit workflow form
- [ ] Add form validation
- [ ] Add duplicate functionality
- [ ] Wire up Alpine.js for interactivity
- [ ] Add "Open in Designer" button (link to MVP-052)

### Phase 5: Polish & Testing (Day 8)
- [ ] Add loading states
- [ ] Add success/error notifications
- [ ] Add keyboard shortcuts
- [ ] Write integration tests
- [ ] Test with multiple workflows
- [ ] Responsive design testing

## UI/UX Considerations

### Layout (Following Work Items Pattern)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agency Designer Navigation                              â”‚
â”‚ ... (other sections)                                    â”‚
â”‚ [RACI Matrix]                                           â”‚
â”‚ [Workflows] â† NEW SECTION                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Workflows Section                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ List     â”‚ Editor Panel                                 â”‚
â”‚ Card     â”‚                                              â”‚
â”‚          â”‚  Workflow Name: [Customer Onboarding      ] â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚  Description:                                â”‚
â”‚ â”‚  ğŸ“‹  â”‚ â”‚  [Multiline text area               ...  ] â”‚
â”‚ â”‚Name  â”‚ â”‚                                              â”‚
â”‚ â”‚  v1  â”‚ â”‚  Version: [1.0.0  ]  Status: [Active   â–¼] â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                                              â”‚
â”‚          â”‚  [Cancel]  [Save]  [Open in Designer â†’]    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚                                              â”‚
â”‚ â”‚  ğŸ“‹  â”‚ â”‚                                              â”‚
â”‚ â”‚Name  â”‚ â”‚                                              â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                                              â”‚
â”‚          â”‚                                              â”‚
â”‚ + New    â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Design Consistency
- **Match existing patterns**: Work Items, Roles, Goals sections
- **Bulma components**: Cards, forms, buttons, notifications
- **Icons**: FontAwesome (fa-sitemap for workflows)
- **Colors**: Follow agency designer theme
- **Spacing**: Consistent with other sections

### User Experience
- **Quick create**: Prominent "New Workflow" button
- **Inline editing**: Click workflow to edit without modal
- **Clear actions**: Edit, duplicate, delete with icons
- **Status indicators**: Color-coded badges
- **Smooth transitions**: Alpine.js animations
- **Responsive**: Works on tablet and desktop

## Testing Strategy

### Unit Tests
- Workflow validation logic
- Node state transitions
- Edge validation rules
- Data transformation functions

### Integration Tests
- API endpoint functionality
- Database persistence
- Execution engine flow
- Error handling and recovery

### E2E Tests
- Create workflow via UI
- Execute workflow end-to-end
- Monitor execution state
- Handle failures and retries

### Performance Tests
- Large workflows (100+ nodes)
- Concurrent workflow executions
- Canvas rendering performance
- Database query optimization

## Success Metrics

- **Development Time**: Complete in 8 days or less
- **Code Reusability**: 80%+ code pattern reuse from Work Items/Roles sections
- **User Adoption**: Users can create/edit workflows within 2 minutes
- **Performance**: List loads < 500ms, CRUD operations < 300ms
- **Foundation for MVP-052**: Smooth transition to visual designer

## Documentation Requirements

- API endpoint documentation
- Templ component usage guide
- Workflow data model reference
- User guide: How to manage workflows
- Developer guide: Adding custom workflow types

## Next Steps (MVP-052)

After completing MVP-051, users will be able to:
1. Click "Open in Designer" button on a workflow
2. Navigate to visual designer (MVP-052)
3. Drag and drop nodes to build workflow visually
4. Connect work items with edges
5. Save visual design back to workflow

**MVP-052 will handle**:
- xyflow integration
- Visual node editor
- Drag-and-drop connections
- Conditional logic and parallel execution
- Real-time execution visualization
