# MVP-052: Workflow Visual Designer

**Priority**: P1 (Critical)  
**Effort**: High  
**Status**: Not Started  
**Dependencies**: MVP-051 (Workflow Manager - List & CRUD)

## Overview

Build a visual drag-and-drop workflow designer using xyflow that enables users to create, edit, and orchestrate work item workflows through an intuitive interface. Users can connect work items, define execution paths, add conditional routing, and configure parallel processing—similar to n8n's workflow builder but specifically tailored for work item orchestration.

## Business Value

- **Visual Process Design**: Non-technical users can design complex work item workflows visually
- **Reduced Development Time**: No code needed to create workflows—drag, drop, and connect
- **Process Transparency**: Clear visualization of how work items flow through the system
- **Real-time Execution Tracking**: Monitor workflow execution state in real-time
- **Intuitive Interface**: Familiar n8n-style workflow building experience

## Technical Stack

### Primary Recommendation: xyflow
**Library**: [xyflow](https://xyflow.com/) - Vanilla JS/TypeScript version

**Why xyflow**:
- **Vanilla JS/TypeScript** - No React dependency, perfect fit for your Alpine.js stack
- Powers n8n's workflow designer (same core engine as ReactFlow)
- Node-based workflow builder with drag-and-drop
- Customizable nodes for different work item types
- Built-in edge routing and validation
- Pan/zoom and minimap support
- Save/load workflow state as JSON
- Lightweight and performant
- Excellent documentation and community
- Integrates seamlessly with Templ templates and Alpine.js

**Key advantages over React-based solutions**:
- No build step complexity for React
- Direct DOM manipulation with Alpine.js
- Smaller bundle size
- Easier integration with server-rendered Templ templates
- More control over rendering and state management

**Alternative Libraries** (if xyflow doesn't meet needs):
- **jsPlumb** - Mature, vanilla JS, good for connecting elements
- **Rete.js** - Lightweight node editor framework
- **Blockly** - Google's visual programming (more block-oriented)

### Integration with Current Stack
- **Backend**: Go (Gin framework)
- **Templates**: Templ for server-side rendering
- **Frontend**: Alpine.js for interactivity + **xyflow** for workflow canvas
- **State Management**: JSON workflow definitions stored in ArangoDB
- **API**: REST endpoints for workflow operations
- **No Build Step**: xyflow works with vanilla JS, integrates directly with your existing stack

## Core Features

### 1. Visual Workflow Canvas

#### Node Types
- **Work Item Node**: Represents individual work items from the registry
  - Display: Work item name, type, estimated duration
  - Configuration: Parameters, SLA settings, assignment rules
  - Status indicators: Draft, active, completed, failed
  - Visual: Custom styled card with icon
  
- **Start Node**: Entry point for workflow execution
  - Trigger types: Manual, scheduled, event-based, API call
  - Visual: Green circle with play icon
  
- **Decision Node**: Conditional branching
  - Condition types: Data comparison, status checks, time-based
  - Multiple output paths based on conditions
  - Visual: Diamond shape with question mark
  
- **Parallel Gateway**: Split/join for concurrent execution
  - Fork: Start multiple work items simultaneously
  - Join: Wait for all parallel branches to complete
  - Visual: Diamond with parallel lines icon
  
- **End Node**: Workflow termination point
  - Success/failure states
  - Cleanup actions
  - Visual: Red circle with stop icon

#### Connection Management
- **Edge Types**:
  - Sequential: Work item B starts after A completes (solid line)
  - Conditional: Edge active only if condition met (dashed line)
  - Data flow: Pass output from one work item to next (line with arrow)
  
- **Validation**:
  - Prevent cycles (unless explicitly allowed for loops)
  - Ensure all paths lead to an end node
  - Validate data compatibility between connected nodes
  - Check for orphaned nodes
  - Real-time validation feedback

#### Canvas Features
- Pan and zoom controls
- Grid snapping for alignment
- Minimap for large workflows
- Auto-layout algorithms (horizontal, vertical, tree)
- Copy/paste nodes and subgraphs
- Undo/redo functionality
- Keyboard shortcuts
- Node search and filtering

### 2. Node Toolbox Panel

Left sidebar with draggable node templates:

**Categories**:
- **Flow Control**: Start, End, Decision, Parallel
- **Work Items**: List of available work items from agency
- **Custom**: User-defined node types

**Interaction**:
- Drag node from toolbox to canvas
- Drop to place at position
- Auto-connect to selected node (optional)

### 3. Properties Panel

Right sidebar for node configuration:

**When Work Item Node Selected**:
- **Basic Info**: Name, description, work item type
- **Assignment**: Role, skill requirements, agent selection strategy
- **SLA/SLO**: Timeouts, escalation rules
- **Input/Output Mapping**: Define data flow between nodes
- **Retry Logic**: Max attempts, backoff strategy
- **Notifications**: Alert settings for stakeholders

**When Decision Node Selected**:
- **Condition Builder**: Visual condition editor
- **Expression Editor**: Advanced condition syntax
- **Output Paths**: Define branches and labels

**When Parallel Node Selected**:
- **Gateway Type**: Fork or Join
- **Execution Strategy**: All parallel, race, etc.

### 4. Workflow Execution Visualization

Real-time execution monitoring overlaid on canvas:

**Node States During Execution**:
- **Pending**: Gray outline
- **Running**: Blue pulsing border
- **Completed**: Green checkmark
- **Failed**: Red X icon
- **Waiting**: Yellow clock icon
- **Skipped**: Gray strikethrough

**Execution Playback**:
- Play/pause execution visualization
- Step through execution history
- View node execution details on hover
- Execution timeline at bottom

### 5. Canvas Toolbar

Top toolbar with common actions:

- **File Operations**: Save, Save As, Export
- **Edit Operations**: Undo, Redo, Cut, Copy, Paste
- **View Operations**: Zoom In/Out, Fit to Screen, Minimap Toggle
- **Layout**: Auto-layout options
- **Validation**: Validate workflow, show errors
- **Execute**: Run workflow, schedule execution
- **Help**: Keyboard shortcuts, documentation

## Data Models

(Uses the same Workflow models from MVP-051, defined in `/internal/workflow/models.go`)

## API Endpoints

### Workflow Designer Operations

```
GET    /api/v1/workflows/:id/nodes          - Get available work items for nodes
PUT    /api/v1/workflows/:id/canvas         - Save canvas state (nodes, edges, positions)
POST   /api/v1/workflows/:id/validate       - Validate workflow structure
GET    /api/v1/workflows/:id/preview        - Get workflow visualization data
```

### Workflow Execution (for visualization)

```
GET    /api/v1/executions/:id/live          - WebSocket for live execution updates
GET    /api/v1/executions/:id/timeline      - Get execution timeline
GET    /api/v1/executions/:id/node/:nodeId  - Get node execution details
```

## Implementation Phases

### Phase 1: Basic Canvas & Integration (Week 1)
- [ ] Set up xyflow via CDN or npm
- [ ] Create workflow designer page template (`workflow_designer.templ`)
- [ ] Initialize xyflow instance with Alpine.js
- [ ] Implement pan/zoom controls
- [ ] Add basic node rendering
- [ ] Load workflow data from MVP-051
- [ ] Save canvas state back to API

### Phase 2: Node Types & Toolbox (Week 2)
- [ ] Create custom node components for each type
- [ ] Build node toolbox panel
- [ ] Implement drag-from-toolbox functionality
- [ ] Style nodes with Bulma CSS
- [ ] Add node icons (FontAwesome)
- [ ] Implement node deletion

### Phase 3: Connections & Validation (Week 3)
- [ ] Implement edge creation (drag between nodes)
- [ ] Add edge styling (sequential, conditional, dataflow)
- [ ] Build validation engine
- [ ] Show validation errors on canvas
- [ ] Prevent invalid connections
- [ ] Implement cycle detection

### Phase 4: Properties Panel (Week 4)
- [ ] Create properties panel component
- [ ] Build work item node editor
- [ ] Build decision node condition editor
- [ ] Build parallel node configuration
- [ ] Save properties to workflow data
- [ ] Implement property validation

### Phase 5: Advanced Features (Week 5)
- [ ] Add minimap component
- [ ] Implement copy/paste
- [ ] Add undo/redo stack
- [ ] Build auto-layout algorithms
- [ ] Add keyboard shortcuts
- [ ] Implement node search

### Phase 6: Execution Visualization (Week 6)
- [ ] Build execution state overlay
- [ ] Implement WebSocket for live updates
- [ ] Add execution playback controls
- [ ] Show node execution details
- [ ] Build execution timeline
- [ ] Add error highlighting

## UI/UX Layout

```
┌────────────────────────────────────────────────────────────┐
│ Workflow Designer: Customer Onboarding        [Save] [Run] │
├─────────┬──────────────────────────────────────┬───────────┤
│ Toolbox │ Canvas Area                          │Properties │
│         │                                      │  Panel    │
│ [Start] │  [Start] ─→ [Collect] ─→ [?] ─→    │           │
│         │               ↓           ↓          │  Name:    │
│ [Work]  │           [Request]   [Verify] ─→   │  [____]   │
│ [Item]  │                          ↓          │           │
│         │                      [End]          │  Type:    │
│ [?]     │                                      │  [____▼]  │
│ Decision│  Minimap                            │           │
│         │  ┌────────┐                         │  [Save]   │
│ [║]     │  │[═══]   │                         │           │
│ Parallel│  └────────┘                         │           │
│         │                                      │           │
│ [End]   │                                      │           │
└─────────┴──────────────────────────────────────┴───────────┘
```

## User Experience

### Navigation Flow
1. User opens workflow from list (MVP-051)
2. Clicks "Open in Designer" button
3. Designer loads with workflow canvas
4. User drags nodes from toolbox
5. Connects nodes by dragging edges
6. Configures node properties
7. Validates workflow
8. Saves and returns to list

### Interaction Patterns
- **Drag to Add**: Drag node from toolbox to canvas
- **Click to Connect**: Click source handle, click target handle
- **Click to Edit**: Click node to show properties panel
- **Right-click Menu**: Context menu for quick actions
- **Hover for Info**: Hover node for tooltip with details
- **Double-click**: Double-click to edit node inline

### Visual Feedback
- **Connection Preview**: Show preview while dragging edge
- **Valid Drop Zones**: Highlight valid connection points
- **Validation Errors**: Red outline on invalid nodes
- **Save Status**: Auto-save indicator
- **Execution State**: Color-coded node borders during execution

## Testing Strategy

### Unit Tests
- Node rendering logic
- Edge validation rules
- Workflow validation engine
- Data transformation functions
- Canvas state management

### Integration Tests
- Save/load workflow from API
- Node property updates
- Validation error display
- Execution state updates via WebSocket

### E2E Tests
- Create workflow from scratch
- Add and connect nodes
- Configure node properties
- Validate and save workflow
- Execute workflow and monitor

### Performance Tests
- Large workflows (100+ nodes)
- Complex nested workflows
- Canvas rendering performance
- Real-time execution updates

## Success Metrics

- **Workflow Creation Time**: Create 10-node workflow < 5 minutes
- **UI Responsiveness**: Canvas operations < 100ms latency
- **User Adoption**: 80% of users prefer visual designer over manual JSON editing
- **Error Rate**: < 5% of workflows have validation errors
- **Performance**: Handle workflows with 100+ nodes smoothly

## Documentation Requirements

- User guide: How to use the visual designer
- Node type reference
- Keyboard shortcuts guide
- Best practices for workflow design
- Troubleshooting guide
- Video tutorials

## Future Enhancements (Post-MVP)

- **Subworkflows**: Reusable workflow components
- **Templates Library**: Pre-built workflow templates
- **Collaboration**: Multi-user editing with conflict resolution
- **Version Diff**: Visual diff between workflow versions
- **AI Assistance**: Suggest workflow optimizations
- **Export Options**: Export as image, PDF
- **Workflow Analytics**: Performance insights and bottlenecks
- **Custom Node Types**: User-defined node types
